import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import DashboardLayout from "./DashboardLayout";
import axios from "axios";
import {
  Briefcase,
  MapPin,
  DollarSign,
  Bookmark,
  BookmarkCheck,
  Loader,
  AlertCircle,
  ExternalLink,
  Filter,
  Search,
  FileText,
  Upload,
  RefreshCw,
  TrendingUp,
  CheckCircle,
  XCircle,
  Brain,
  Zap,
  ChevronDown,
  ChevronUp,
} from "lucide-react";

const API_URL = import.meta.env.VITE_API_URL || import.meta.env.VITE_API_BASE_URL || "http://localhost:3000";

interface Job {
  _id?: string;
  id?: string;
  title: string;
  company: string;
  location: string;
  description: string;
  url: string;
  platform?: string;
  source?: string;
  postedDate?: string;
  salary?: string;
  matchPercentage?: number;
  match_score?: number;
  matchScore?: number;
  matchedSkills?: string[];
  missingSkills?: string[];
  skillScore?: number;
  semanticScore?: number;
  titleScore?: number;
  experienceScore?: number;
  easyApply?: boolean;
}

const JobSeekerJobs = () => {
  const navigate = useNavigate();
  const [jobs, setJobs] = useState<Job[]>([]);
  const [filteredJobs, setFilteredJobs] = useState<Job[]>([]);
  const [loading, setLoading] = useState(true);
  const [searching, setSearching] = useState(false);
  const [error, setError] = useState("");
  const [savedJobs, setSavedJobs] = useState<string[]>([]);
  const [searchTerm, setSearchTerm] = useState("");
  const [platformFilter, setPlatformFilter] = useState("all");
  const [hasResume, setHasResume] = useState(false);
  const [resumeData, setResumeData] = useState<any>(null);
  const [customJobTitle, setCustomJobTitle] = useState("");
  const [customLocation, setCustomLocation] = useState("");
  const [expandedJob, setExpandedJob] = useState<string | null>(null);
  const [sortBy, setSortBy] = useState<"match" | "recent">("match");

  const platforms = ["all", "Indeed", "Rozee", "Glassdoor", "Mustakbil"];

  useEffect(() => {
    fetchResumeAndJobs();
  }, []);

  useEffect(() => {
    filterJobs();
  }, [jobs, searchTerm, platformFilter, sortBy]);

  const fetchResumeAndJobs = async () => {
    try {
      setLoading(true);
      const token = localStorage.getItem("token");
      const response = await axios.get(`${API_URL}/api/jobseeker/my-resumes`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.data.success && response.data.data?.resumes?.length > 0) {
        const resume = response.data.data.resumes[0];
        setResumeData(resume);
        setHasResume(true);

        // Use cached jobs if available and recent
        const cachedJobs = localStorage.getItem('veriresume_cached_jobs');
        const cachedTimestamp = localStorage.getItem('veriresume_jobs_timestamp');
        const cacheAge = cachedTimestamp ? Date.now() - parseInt(cachedTimestamp) : Infinity;

        if (cachedJobs && cacheAge < 30 * 60 * 1000) {
          try {
            const parsed = JSON.parse(cachedJobs);
            if (parsed.length > 0) {
              setJobs(parsed);
              return;
            }
          } catch (e) {}
        }

        await fetchMatchingJobs(resume);
      } else {
        setHasResume(false);
      }
    } catch (err: any) {
      console.error("Failed to fetch resume:", err);
      setError("Failed to load data");
    } finally {
      setLoading(false);
    }
  };

  const fetchMatchingJobs = async (resume?: any) => {
    const r = resume || resumeData;
    if (!r?._id) return;
    setSearching(true);
    setError("");
    try {
      const token = localStorage.getItem("token");
      const body: any = { resumeId: r._id };
      if (customJobTitle.trim()) body.jobTarget = customJobTitle.trim();
      if (customLocation.trim()) body.location = customLocation.trim();
      const response = await axios.post(
        `${API_URL}/api/jobseeker/find-matching-jobs`,
        body,
        { headers: { Authorization: `Bearer ${token}` }, timeout: 90000 }
      );
      if (response.data.success) {
        const allJobs = response.data.data?.allMatchingJobs || response.data.data?.matchingJobs || response.data.data?.jobs || [];
        setJobs(allJobs);
        localStorage.setItem('veriresume_cached_jobs', JSON.stringify(allJobs));
        localStorage.setItem('veriresume_jobs_timestamp', Date.now().toString());
      }
    } catch (err: any) {
      console.error("Failed to fetch jobs:", err);
      setError("Failed to find matching jobs. Try again later.");
    } finally {
      setSearching(false);
    }
  };

  const filterJobs = () => {
    let filtered = jobs;
    if (searchTerm) {
      filtered = filtered.filter(
        (job) =>
          job.title?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          job.company?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          job.location?.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }
    if (platformFilter !== "all") {
      filtered = filtered.filter((job) =>
        (job.platform || job.source)?.toLowerCase().includes(platformFilter.toLowerCase())
      );
    }
    // Sort
    filtered.sort((a, b) => {
      if (sortBy === "match") {
        return (b.matchScore || b.matchPercentage || 0) - (a.matchScore || a.matchPercentage || 0);
      }
      return 0; // keep original order for "recent"
    });
    setFilteredJobs(filtered);
  };

  const toggleSaveJob = (jobId: string) => {
    setSavedJobs((prev) =>
      prev.includes(jobId) ? prev.filter((id) => id !== jobId) : [...prev, jobId]
    );
  };

  const getPlatformBadge = (platform: string) => {
    const colors: Record<string, string> = {
      indeed: "bg-blue-100 text-blue-700 border-blue-200",
      rozee: "bg-green-100 text-green-700 border-green-200",
      glassdoor: "bg-purple-100 text-purple-700 border-purple-200",
      mustakbil: "bg-orange-100 text-orange-700 border-orange-200",
    };
    return colors[platform?.toLowerCase()] || "bg-slate-100 text-slate-700 border-slate-200";
  };

  const getMatchColor = (score: number) => {
    if (score >= 75) return "text-green-600 bg-green-50 border-green-200";
    if (score >= 50) return "text-amber-600 bg-amber-50 border-amber-200";
    return "text-red-600 bg-red-50 border-red-200";
  };

  const getMatchLabel = (score: number) => {
    if (score >= 85) return "Excellent Match";
    if (score >= 70) return "Strong Match";
    if (score >= 50) return "Good Match";
    if (score >= 35) return "Partial Match";
    return "Low Match";
  };

  if (loading) {
    return (
      <DashboardLayout title="Job Recommendations" subtitle="AI-matched jobs from multiple platforms">
        <div className="flex items-center justify-center h-96">
          <div className="text-center">
            <Loader className="w-12 h-12 animate-spin text-cyan-600 mx-auto mb-4" />
            <p className="text-slate-600">Finding jobs for you...</p>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout title="Job Recommendations" subtitle="AI-matched jobs based on your resume using NLP + Semantic Similarity">
      {error && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl flex items-center text-red-700">
          <AlertCircle className="w-5 h-5 mr-3 flex-shrink-0" />
          {error}
          <button onClick={() => setError("")} className="ml-auto text-red-500 hover:text-red-700">Ã—</button>
        </div>
      )}

      {!hasResume ? (
        <div className="bg-white rounded-2xl shadow-lg p-12 text-center border border-slate-200">
          <FileText className="w-16 h-16 text-slate-300 mx-auto mb-4" />
          <h3 className="text-xl font-semibold text-slate-900 mb-2">No Resume Uploaded</h3>
          <p className="text-slate-600 mb-6">Upload your resume to get AI-powered job recommendations that match your skills</p>
          <button
            onClick={() => navigate("/jobseeker/upload")}
            className="px-8 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-xl hover:shadow-lg transition-all font-semibold flex items-center gap-2 mx-auto"
          >
            <Upload size={20} /> Upload Resume
          </button>
        </div>
      ) : (
        <>
          {/* Resume Info Banner */}
          <div className="bg-gradient-to-r from-cyan-600 to-blue-600 rounded-2xl p-6 text-white mb-6 flex items-center justify-between">
            <div>
              <h3 className="text-lg font-bold flex items-center gap-2">
                <Brain size={22} /> AI Job Matching Active
              </h3>
              <p className="text-blue-100 text-sm mt-1">
                Matching based on: <span className="font-semibold text-white">{resumeData?.parsedData?.skills?.slice(0, 5).join(', ') || 'your skills'}</span>
                {resumeData?.jobTarget && <> | Target: <span className="font-semibold text-white">{resumeData.jobTarget}</span></>}
              </p>
            </div>
            <div className="text-right">
              <p className="text-3xl font-bold">{filteredJobs.length}</p>
              <p className="text-blue-100 text-sm">Jobs Found</p>
            </div>
          </div>

          {/* Custom Search Fields */}
          <div className="bg-white rounded-2xl p-6 border border-slate-200 mb-6">
            <h3 className="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
              <Briefcase size={16} className="text-cyan-600" />
              Custom Job Search (Optional)
            </h3>
            <div className="grid md:grid-cols-3 gap-4 mb-4">
              <div className="relative">
                <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                <input
                  type="text"
                  placeholder="Job title (e.g. Software Engineer)"
                  value={customJobTitle}
                  onChange={(e) => setCustomJobTitle(e.target.value)}
                  className="w-full pl-11 pr-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500 text-sm"
                />
              </div>
              <div className="relative">
                <MapPin className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                <input
                  type="text"
                  placeholder="Location (e.g. Lahore)"
                  value={customLocation}
                  onChange={(e) => setCustomLocation(e.target.value)}
                  className="w-full pl-11 pr-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500 text-sm"
                />
              </div>
              <button
                onClick={() => fetchMatchingJobs()}
                disabled={searching}
                className="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all disabled:opacity-50 text-sm"
              >
                <Search className={`w-4 h-4 ${searching ? "animate-spin" : ""}`} />
                {searching ? "Searching..." : "Search Jobs"}
              </button>
            </div>
            <p className="text-xs text-slate-500">Leave blank to auto-search based on your resume profile</p>
          </div>

          {/* Filter Bar */}
          <div className="bg-white rounded-2xl p-6 border border-slate-200 mb-6">
            <div className="grid md:grid-cols-4 gap-4 mb-4">
              <div className="relative md:col-span-2">
                <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20} />
                <input
                  type="text"
                  placeholder="Filter results by title, company, or location..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full pl-12 pr-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500"
                />
              </div>
              <div className="flex items-center gap-2">
                <Filter className="text-slate-400 flex-shrink-0" size={20} />
                <select
                  value={platformFilter}
                  onChange={(e) => setPlatformFilter(e.target.value)}
                  className="flex-1 px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500"
                >
                  {platforms.map((p) => (
                    <option key={p} value={p}>{p === "all" ? "All Platforms" : p}</option>
                  ))}
                </select>
              </div>
              <div className="flex items-center gap-2">
                <TrendingUp className="text-slate-400 flex-shrink-0" size={20} />
                <select
                  value={sortBy}
                  onChange={(e) => setSortBy(e.target.value as any)}
                  className="flex-1 px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500"
                >
                  <option value="match">Best Match</option>
                  <option value="recent">Most Recent</option>
                </select>
              </div>
            </div>
            <div className="flex items-center justify-between">
              <p className="text-sm text-slate-600">
                Found <span className="font-bold text-slate-900">{filteredJobs.length}</span> jobs matching your profile
              </p>
              <button
                onClick={() => fetchMatchingJobs()}
                disabled={searching}
                className="flex items-center gap-2 px-4 py-2 bg-cyan-50 text-cyan-700 rounded-xl hover:bg-cyan-100 transition-all font-semibold text-sm disabled:opacity-50"
              >
                <RefreshCw className={`w-4 h-4 ${searching ? "animate-spin" : ""}`} />
                {searching ? "Searching..." : "Refresh Jobs"}
              </button>
            </div>
          </div>

          {/* Searching State */}
          {searching && (
            <div className="flex items-center justify-center py-20">
              <div className="text-center">
                <Loader className="animate-spin text-cyan-600 mx-auto mb-4" size={40} />
                <p className="text-slate-600 font-medium">Scraping & matching jobs from multiple platforms...</p>
                <p className="text-slate-500 text-sm mt-1">Using NLP + Semantic Similarity to find the best matches</p>
              </div>
            </div>
          )}

          {/* No Jobs */}
          {!searching && filteredJobs.length === 0 && (
            <div className="text-center py-20 bg-white rounded-2xl border border-slate-200">
              <Briefcase className="mx-auto text-slate-300" size={64} />
              <p className="text-slate-600 text-lg mt-4 font-medium">No jobs found</p>
              <p className="text-slate-500 mt-2">Try adjusting filters or click Refresh to search again</p>
            </div>
          )}

          {/* Jobs List */}
          {!searching && filteredJobs.length > 0 && (
            <div className="space-y-4">
              {filteredJobs.map((job, idx) => {
                const matchScore = job.matchPercentage || job.matchScore || job.match_score || 0;
                const jobId = job._id || job.id || `job-${idx}`;
                const isExpanded = expandedJob === jobId;
                const platform = (job.platform || job.source || 'unknown').toLowerCase();
                const platformLabel = platform.charAt(0).toUpperCase() + platform.slice(1);

                return (
                  <div
                    key={jobId}
                    className="bg-white rounded-2xl border border-slate-200 hover:border-cyan-300 hover:shadow-lg transition-all overflow-hidden"
                  >
                    <div className="p-6">
                      {/* Top Row: Title + Match Score */}
                      <div className="flex items-start justify-between gap-4 mb-3">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-3 mb-1">
                            <h3 className="text-lg font-bold text-slate-900 truncate">
                              {job.title}
                            </h3>
                            <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold border ${getPlatformBadge(platform)}`}>
                              {platformLabel}
                            </span>
                            {job.easyApply && (
                              <span className="inline-flex items-center px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded-full text-xs font-semibold border border-emerald-200">
                                <Zap size={10} className="mr-1" /> Easy Apply
                              </span>
                            )}
                          </div>
                          <p className="text-sm text-slate-600">{job.company}</p>
                        </div>

                        {/* Match Score Circle */}
                        <div className="flex items-center gap-3 flex-shrink-0">
                          <div className={`relative w-16 h-16 rounded-full flex items-center justify-center border-4 ${
                            matchScore >= 75 ? 'border-green-400 bg-green-50' :
                            matchScore >= 50 ? 'border-amber-400 bg-amber-50' :
                            'border-red-300 bg-red-50'
                          }`}>
                            <div className="text-center">
                              <p className={`text-lg font-bold ${
                                matchScore >= 75 ? 'text-green-700' :
                                matchScore >= 50 ? 'text-amber-700' :
                                'text-red-600'
                              }`}>{Math.round(matchScore)}%</p>
                            </div>
                          </div>
                          <button
                            onClick={() => toggleSaveJob(jobId)}
                            className="p-2 hover:bg-slate-100 rounded-lg transition-all"
                          >
                            {savedJobs.includes(jobId) ? (
                              <BookmarkCheck className="text-cyan-600 fill-current" size={20} />
                            ) : (
                              <Bookmark className="text-slate-400" size={20} />
                            )}
                          </button>
                        </div>
                      </div>

                      {/* Details Row */}
                      <div className="flex flex-wrap items-center gap-4 text-sm text-slate-600 mb-4">
                        {job.location && (
                          <div className="flex items-center gap-1.5">
                            <MapPin size={14} className="text-slate-400" />
                            <span>{job.location}</span>
                          </div>
                        )}
                        {job.salary && (
                          <div className="flex items-center gap-1.5">
                            <DollarSign size={14} className="text-slate-400" />
                            <span>{job.salary}</span>
                          </div>
                        )}
                        {job.postedDate && (
                          <span className="text-slate-400">Posted: {job.postedDate}</span>
                        )}
                        <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${getMatchColor(matchScore)}`}>
                          {getMatchLabel(matchScore)}
                        </span>
                      </div>

                      {/* Matched Skills */}
                      {job.matchedSkills && job.matchedSkills.length > 0 && (
                        <div className="mb-4">
                          <p className="text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wider">Matched Skills</p>
                          <div className="flex flex-wrap gap-1.5">
                            {job.matchedSkills.map((skill: string, i: number) => (
                              <span key={i} className="inline-flex items-center gap-1 px-2.5 py-1 bg-green-50 text-green-700 rounded-lg text-xs font-semibold border border-green-200">
                                <CheckCircle size={10} /> {skill}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Missing Skills (show only if expanded) */}
                      {isExpanded && job.missingSkills && job.missingSkills.length > 0 && (
                        <div className="mb-4">
                          <p className="text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wider">Skills to Develop</p>
                          <div className="flex flex-wrap gap-1.5">
                            {job.missingSkills.slice(0, 8).map((skill: string, i: number) => (
                              <span key={i} className="inline-flex items-center gap-1 px-2.5 py-1 bg-red-50 text-red-600 rounded-lg text-xs font-semibold border border-red-200">
                                <XCircle size={10} /> {skill}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Score Breakdown (expanded) */}
                      {isExpanded && (job.skillScore || job.semanticScore) && (
                        <div className="mb-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                          <p className="text-xs font-semibold text-slate-500 mb-3 uppercase tracking-wider flex items-center gap-1">
                            <Brain size={12} /> AI Score Breakdown
                          </p>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            {[
                              { label: "Skill Match", score: job.skillScore || 0, color: "cyan" },
                              { label: "Semantic", score: job.semanticScore || 0, color: "blue" },
                              { label: "Title Match", score: job.titleScore || 0, color: "purple" },
                              { label: "Experience", score: job.experienceScore || 0, color: "green" },
                            ].map((item, i) => (
                              <div key={i} className="text-center">
                                <div className="text-lg font-bold text-slate-900">{item.score}%</div>
                                <div className="text-xs text-slate-500">{item.label}</div>
                                <div className="w-full bg-slate-200 rounded-full h-1.5 mt-1">
                                  <div className={`bg-${item.color}-500 h-1.5 rounded-full transition-all`} style={{ width: `${item.score}%` }} />
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Description (expanded) */}
                      {isExpanded && job.description && (
                        <div className="mb-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                          <p className="text-sm text-slate-700">{job.description}</p>
                        </div>
                      )}

                      {/* Action Buttons */}
                      <div className="flex items-center gap-3 mt-2">
                        <a
                          href={job.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex-1 flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all text-sm"
                        >
                          <ExternalLink size={16} />
                          View & Apply on {platformLabel}
                        </a>
                        <button
                          onClick={() => setExpandedJob(isExpanded ? null : jobId)}
                          className="px-4 py-3 border border-slate-300 text-slate-600 rounded-xl hover:bg-slate-50 transition-all text-sm font-semibold flex items-center gap-1"
                        >
                          {isExpanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                          {isExpanded ? "Less" : "Details"}
                        </button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </>
      )}
    </DashboardLayout>
  );
};

export default JobSeekerJobs;
